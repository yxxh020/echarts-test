import { Component, OnInit, PLATFORM_ID, Inject } from '@angular/core';
import { NgxEchartsModule } from 'ngx-echarts';
import { CommonModule, isPlatformBrowser } from '@angular/common';
import type { EChartsOption } from 'echarts';

export interface SleepData {
  Date: string;
  allSleepTime: string;
  deepSleepTime: string;
  lowSleepTime: string;
  sleepDown: string;
  sleepLine: string;
  sleepUp: string;
  wakeCount: string;
}

@Component({
  selector: 'app-echarts',
  standalone: true,
  imports: [NgxEchartsModule, CommonModule],
  templateUrl: './echarts.component.html',
  styles: ['.demo-chart { height: 400px; }']
})
export class EchartsComponent implements OnInit {
  chartOptions: EChartsOption = {};
  isBrowser: boolean;
  allSleepTime: string = ''; // 총수면시간
  deepSleepTime: string = ''; // 깊은수면
  lowSleepTime: string = ''; // 얕은수면
  wakeCount: string = ''; // 수면 중 기상

  constructor(@Inject(PLATFORM_ID) private platformId: Object) {
    this.isBrowser = isPlatformBrowser(this.platformId);
  }

  private sleepData = {
    Date: '2024-10-15',
    allSleepTime: '396',
    deepSleepTime: '107',
    lowSleepTime: '222',
    sleepDown: 'TimeData [2024-10-15 02:15:00]',
    sleepLine: '002000111212121212121111111212000000211022222232334322211222000011121211112200000000000111212121212121111111212',
    sleepUp: 'TimeData [2024-10-15 04:06:00]',
    graph: [["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4],["2024-10-15 02:15:00", 0],["2024-10-15 02:16:00",1],["2024-10-15 02:17:00",1],["2024-10-15 02:18:00",2],["2024-10-15 02:19:00",1],["2024-10-15 02:20:00",2],["2024-10-15 02:21:00",1],["2024-10-15 02:22:00",3],["2024-10-15 02:23:00",4],["2024-10-15 02:24:00",1],["2024-10-15 02:25:00",1],["2024-10-15 02:26:00",1],["2024-10-15 02:27:00", 2],["2024-10-15 02:28:00", 0],["2024-10-15 02:29:00", 0],["2024-10-15 02:30:00", 4]],
    wakeCount: '1'
  };

  ngOnInit(): void {
    if (this.isBrowser) {
      this.initChart();
      this.processSleeData(this.sleepData);
    }
  }
  
  async initChart(): Promise<void> {
    // const echarts = await import('echarts');

    const xaxis = this.sleepData.graph.map(function (item: (string | number)[]) {
      return item[0].toString();
    });
    const yaxis = this.sleepData.graph.map(function (item: (string | number)[]) {
      return item[1];
    });

    this.chartOptions = {
      title: { text: 'Sleep Graph' },
      tooltip: {
        trigger: 'axis',
        formatter: (params: any) => {
          const sleepStage = yaxis[params[0].dataIndex];
          let stageName = '';

          switch (sleepStage) {
            case 0: stageName = '깊은 수면'; break;
            case 1: stageName = '얕은 수면'; break;
            case 2: stageName = '렘 수면'; break;
            case 3: stageName = '불면증'; break;
            case 4: stageName = '깸'; break;
            default: stageName = 'Unknown';
          }

          return `${params[0].name}: ${stageName}`;
        }
      },
      xAxis: {
        type: 'category',
        data: xaxis,
        axisLabel: {
          formatter: (value: string) => {
            return value.slice(11, 16); //HH:mm
          }
        }
      },
      yAxis: {
        type: 'value',
        min: 0,
        max: 4,
        interval: 1,
        axisLabel: {
          formatter: (value: number) => {
            switch (value) {
              case 0: return '깊은 수면';
              case 1: return '얕은 수면';
              case 2: return '렘 수면';
              case 3: return '불면증';
              case 4: return '깸';
              default: return '';
            }
          }
        }
      },
      visualMap: {
        top: 50,
        right: 10,
        pieces: [
          { gt: 0, lte: 1, color: '#93CE07' },  // 깊은 수면
          { gt: 1, lte: 2, color: '#FBDB0F' },  // 얕은 수면
          { gt: 2, lte: 3, color: '#FC7D02' },  // 렘 수면
          { gt: 3, lte: 4, color: '#FD0100' },  // 불면증
        ],
        outOfRange: {
          color: '#999'
        }
      },
      series: [
        {
          name: 'Sleep Stages',
          type: 'line',
          data: yaxis,
          markLine: {
            silent: true,
            lineStyle: {
              color: '#333'
            },
            data: [
              { yAxis: 1 },  // 얕은 수면 기준선
              { yAxis: 2 },  // 렘수면 기준선
              { yAxis: 3 },  // 불면증 기준선
            ]
          }
        }
      ]
    };
  }

  private processSleeData(data: SleepData): void {
    this.allSleepTime = (parseInt(data.allSleepTime, 10) / 60).toFixed(2);
    this.deepSleepTime = (parseInt(data.deepSleepTime, 10) / 60).toFixed(2);
    this.lowSleepTime = (parseInt(data.lowSleepTime, 10) / 60).toFixed(2);
    this.wakeCount = data.wakeCount;
  }
}
